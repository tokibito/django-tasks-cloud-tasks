<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django Tasks Cloud Tasks Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; }
        h2 { color: #555; margin-top: 30px; }
        .task-forms {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .task-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .task-card h3 {
            margin-top: 0;
            color: #333;
        }
        .task-card p {
            color: #666;
            font-size: 14px;
        }
        input, button {
            padding: 8px 12px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        input { width: calc(100% - 26px); }
        button {
            background: #4285f4;
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
        }
        button:hover { background: #3367d6; }
        .info-card {
            background: #e8f5e9;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .info-card h3 {
            margin-top: 0;
            color: #2e7d32;
        }
        .info-card pre {
            background: #333;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
        }
        .warning-card {
            background: #fff3e0;
            border: 1px solid #ff9800;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .warning-card h3 {
            margin-top: 0;
            color: #e65100;
        }
        .recent-tasks {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }
        .recent-tasks h3 {
            margin-top: 0;
        }
        .task-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .task-list li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-list li:last-child {
            border-bottom: none;
        }
        .task-id {
            font-family: monospace;
            font-size: 12px;
            color: #666;
        }
        .task-path {
            color: #333;
            font-weight: 500;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-NEW { background: #e3f2fd; color: #1565c0; }
        .status-RUNNING { background: #fff3e0; color: #e65100; }
        .status-COMPLETE { background: #e8f5e9; color: #2e7d32; }
        .status-FAILED { background: #ffebee; color: #c62828; }
        a { color: #4285f4; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h1>Django Tasks Cloud Tasks Demo</h1>

    <div class="warning-card">
        <h3>Cloud Tasks Backend</h3>
        <p>This sample project uses Google Cloud Tasks as the task backend. Tasks are enqueued to Cloud Tasks and executed via HTTP callback.</p>
        <p><strong>Note:</strong> Since task state is not stored in database, recent tasks list is not available. Check Cloud Tasks console or server logs for task execution status.</p>
    </div>

    <h2>Enqueue Tasks</h2>
    <div class="task-forms">
        <div class="task-card">
            <h3>Add Numbers</h3>
            <p>Add two numbers together</p>
            <form method="post" action="{% url 'enqueue_add' %}">
                {% csrf_token %}
                <input type="number" name="x" placeholder="X" value="10">
                <input type="number" name="y" placeholder="Y" value="20">
                <button type="submit">Enqueue</button>
            </form>
        </div>

        <div class="task-card">
            <h3>Send Notification</h3>
            <p>Simulate sending a notification</p>
            <form method="post" action="{% url 'enqueue_notify' %}">
                {% csrf_token %}
                <input type="text" name="user_id" placeholder="User ID" value="user-123">
                <input type="text" name="message" placeholder="Message" value="Hello from Cloud Tasks!">
                <button type="submit">Enqueue</button>
            </form>
        </div>

        <div class="task-card">
            <h3>Process Data</h3>
            <p>Simulate data processing</p>
            <form method="post" action="{% url 'enqueue_process' %}">
                {% csrf_token %}
                <input type="text" name="data_id" placeholder="Data ID" value="data-001">
                <button type="submit">Enqueue</button>
            </form>
        </div>

        <div class="task-card">
            <h3>Urgent Task</h3>
            <p>High-priority queue task</p>
            <form method="post" action="{% url 'enqueue_urgent' %}">
                {% csrf_token %}
                <input type="text" name="task_name" placeholder="Task Name" value="important-job">
                <button type="submit">Enqueue</button>
            </form>
        </div>

        <div class="task-card">
            <h3>Context Task</h3>
            <p>Task that uses task context</p>
            <form method="post" action="{% url 'enqueue_context' %}">
                {% csrf_token %}
                <input type="text" name="message" placeholder="Message" value="Hello with context!">
                <button type="submit">Enqueue</button>
            </form>
        </div>

        <div class="task-card">
            <h3>Failing Task</h3>
            <p>Task that always fails (for retry testing)</p>
            <form method="post" action="{% url 'enqueue_failing' %}">
                {% csrf_token %}
                <button type="submit">Enqueue</button>
            </form>
        </div>
    </div>

    <h2>Local Testing</h2>
    <div class="info-card">
        <h3>Without Cloud Tasks Emulator</h3>
        <p>You can manually simulate the Cloud Tasks HTTP callback by sending POST requests to the task execution endpoint:</p>
        <pre>
# Simulate addition task execution
curl -X POST http://localhost:8000/cloudtasks/execute/ \
  -H "Content-Type: application/json" \
  -d '{
    "task_id": "test-task-001",
    "task_path": "sample_app.tasks.add_numbers",
    "args": [5, 3],
    "kwargs": {},
    "queue_name": "default",
    "backend": "default",
    "priority": 0,
    "takes_context": false,
    "enqueued_at": "2024-01-01T00:00:00+00:00"
  }'</pre>
    </div>

    <div class="info-card">
        <h3>With Cloud Tasks Emulator</h3>
        <p>Run the following commands to start the emulator:</p>
        <pre>
# Start Cloud Tasks emulator
gcloud beta emulators tasks start --host-port=localhost:8123

# Set environment variables
export CLOUD_TASKS_EMULATOR_HOST=localhost:8123
export GOOGLE_CLOUD_PROJECT="sample-project"
export CLOUD_TASKS_LOCATION="asia-northeast1"
export SERVICE_URL="http://localhost:8000"

# Create queues
gcloud tasks queues create default --location=asia-northeast1 --project=sample-project
gcloud tasks queues create high-priority --location=asia-northeast1 --project=sample-project

# Start Django server
python manage.py runserver</pre>
    </div>
</body>
</html>
